<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>STEIN AUF STEIN • Premium Asistan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
 
  <style>
    /* === STEIN AUF STEIN: ULTRA PREMIUM THEME === */
    :root {
      --hc-bg: #f3f4f6;
      --hc-panel-bg: #ffffff;
      --hc-border: #e5e7eb;
     
      /* Marka Renkleri */
      --hc-primary: #111827;       /* Slate 900 - Lüks Siyah */
      --hc-primary-hover: #374151;
      --hc-accent: #d4af37;        /* Metalik Altın */
      --hc-accent-light: #fbf5e6;
     
      --hc-text-main: #1f2937;
      --hc-text-sub: #6b7280;
     
      --hc-bot-bubble: #f9fafb;
      --hc-user-bubble: #111827;
      --hc-user-text: #ffffff;
     
      --hc-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
      --hc-radius: 20px;
    }

    /* === SCROLL FIX & RESET === */
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%; /* Tam ekran sabitleme */
      height: 100dvh; /* Dynamic Viewport Height (Mobil adres çubuğu sorunu için) */
      overflow: hidden; /* Sayfanın kendisi kaymasın */
      font-family: 'Manrope', sans-serif;
      background-color: var(--hc-bg);
      color: var(--hc-text-main);
      display: flex; justify-content: center; align-items: center;
      -webkit-font-smoothing: antialiased;
      touch-action: manipulation; /* Zoom engelleme */
    }

    /* === EMBED MODE === */
    body.hc-embed-mode { background: transparent; }
    body.hc-embed-mode .hc-wrapper {
      width: 100%; height: 100%; max-height: none;
      border-radius: 0; border: none; box-shadow: none;
      grid-template-columns: 1fr;
    }
    body.hc-embed-mode .hc-brand-side { display: none; }

    /* Ana Kapsayıcı */
    .hc-wrapper {
      width: 1100px; height: 90vh; max-height: 850px;
      display: grid; grid-template-columns: 320px 1fr;
      background: var(--hc-panel-bg);
      border-radius: var(--hc-radius);
      box-shadow: var(--hc-shadow);
      overflow: hidden;
      border: 1px solid var(--hc-border);
      position: relative;
    }

    /* --- SOL TARA (Marka & Bilgi) --- */
    .hc-brand-side {
      background: #f8fafc;
      border-right: 1px solid var(--hc-border);
      padding: 40px 32px;
      display: flex; flex-direction: column; gap: 32px;
      z-index: 2;
    }
   
    .hc-brand-header { display: flex; align-items: center; gap: 16px; }
    .hc-logo-icon {
      width: 54px; height: 54px;
      background: var(--hc-primary); color: var(--hc-accent);
      border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .hc-logo-icon svg { width: 30px; height: 30px; fill: currentColor; }

    .hc-brand-texts h1 { font-size: 18px; font-weight: 800; margin: 0; letter-spacing: -0.02em; color: var(--hc-text-main); line-height: 1.2; }
    .hc-brand-texts p { font-size: 12px; margin: 4px 0 0 0; color: var(--hc-accent); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; }
   
    .hc-feature-list {
      margin-top: auto; display: flex; flex-direction: column; gap: 20px;
    }
    .hc-feature-item { display: flex; gap: 14px; align-items: flex-start; }
    .hc-feature-icon {
      width: 36px; height: 36px; border-radius: 10px; background: #fff;
      border: 1px solid var(--hc-border); display: flex; align-items: center; justify-content: center;
      color: var(--hc-primary); flex-shrink: 0;
    }
    .hc-feature-text h4 { margin: 0 0 4px 0; font-size: 13px; font-weight: 700; }
    .hc-feature-text p { margin: 0; font-size: 12px; color: var(--hc-text-sub); line-height: 1.4; }

    /* --- SAĞ TARAF (Chat Paneli) --- */
    .hc-chat-panel {
      display: flex; flex-direction: column;
      background: #fff; position: relative;
      height: 100%; overflow: hidden;
    }

    /* Header */
    .hc-chat-head {
      padding: 20px 30px;
      border-bottom: 1px solid var(--hc-border);
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      z-index: 10; flex-shrink: 0;
    }
    .hc-agent-info { display: flex; align-items: center; gap: 14px; }
    .hc-agent-avatar-head {
      width: 44px; height: 44px; border-radius: 50%; object-fit: cover;
      border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .hc-agent-text h3 { margin: 0; font-size: 15px; font-weight: 700; color: var(--hc-text-main); }
    .hc-agent-text span { font-size: 12px; color: #10b981; font-weight: 600; display: flex; align-items: center; gap: 4px; }
    .hc-agent-text span::before { content:""; width:6px; height:6px; background:#10b981; border-radius:50%; }

    .hc-end-chat-btn {
      background: transparent; border: 1px solid var(--hc-border);
      color: var(--hc-text-sub); cursor: pointer; padding: 8px 14px;
      border-radius: 8px; font-size: 12px; font-weight: 600;
      transition: all 0.2s;
    }
    .hc-end-chat-btn:hover { background: #fee2e2; color: #ef4444; border-color: #fee2e2; }

    /* Mesaj Alanı (SCROLL AREA) */
    .hc-msgs-area {
      flex: 1; padding: 30px;
      overflow-y: auto;
      overscroll-behavior: contain; /* Parent scroll engelleme */
      display: flex; flex-direction: column; gap: 24px;
      scroll-behavior: smooth;
    }
    /* Scrollbar Gizleme/İnceltme */
    .hc-msgs-area::-webkit-scrollbar { width: 6px; }
    .hc-msgs-area::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }

    .hc-row { display: flex; gap: 16px; align-items: flex-end; animation: hcSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .hc-row.hc-user { justify-content: flex-end; }
   
    /* Bot Profil Resmi (Mesaj İçi) */
    .hc-msg-avatar {
      width: 38px; height: 38px; border-radius: 12px; object-fit: cover;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08); flex-shrink: 0;
    }
   
    .hc-bubble-group { display: flex; flex-direction: column; gap: 6px; max-width: 75%; }

    .hc-bubble {
      padding: 16px 22px; border-radius: 18px; font-size: 15px; line-height: 1.6;
      position: relative; word-wrap: break-word;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
   
    .hc-row.hc-bot .hc-bubble {
      background: var(--hc-bot-bubble); color: var(--hc-text-main);
      border-bottom-left-radius: 4px;
    }
    .hc-row.hc-user .hc-bubble {
      background: var(--hc-user-bubble); color: var(--hc-user-text);
      border-bottom-right-radius: 4px;
    }

    /* Like Button Action Bar */
    .hc-bot-actions {
      display: flex; gap: 10px; padding-left: 4px; opacity: 0; animation: hcFadeIn 0.5s 0.2s forwards;
    }
    .hc-like-btn {
      background: none; border: none; cursor: pointer; padding: 4px;
      color: #9ca3af; transition: all 0.2s; display: flex; align-items: center; gap: 4px;
      font-size: 11px;
    }
    .hc-like-btn svg { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 2; }
    .hc-like-btn:hover { color: var(--hc-primary); transform: scale(1.1); }
    .hc-like-btn.liked { color: #ef4444; } /* Kırmızı Kalp */
    .hc-like-btn.liked svg { fill: #ef4444; stroke: #ef4444; }

    /* Hızlı Sorular (Chips) */
    .hc-suggestions {
      margin-top: auto; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; padding-top: 20px;
    }
    .hc-chip {
      background: #fff; border: 1px solid var(--hc-accent);
      color: var(--hc-primary);
      padding: 12px 20px; border-radius: 12px 12px 2px 12px; /* Konuşma balonu gibi */
      font-size: 13px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
      max-width: 90%; text-align: right;
    }
    .hc-chip:hover {
      background: var(--hc-primary); color: #fff; border-color: var(--hc-primary);
      transform: translateX(-5px);
    }

    /* Input Alanı (Optimize Edilmiş) */
    .hc-input-area {
      padding: 24px 30px; border-top: 1px solid var(--hc-border);
      background: #fff; display: flex; gap: 16px; align-items: flex-end;
      flex-shrink: 0; position: relative;
    }
    .hc-textarea-wrap {
      flex: 1; position: relative; display: flex;
    }
    .hc-textarea {
      width: 100%; border: 2px solid transparent; background: #f3f4f6;
      border-radius: 16px; padding: 18px 20px;
      font-size: 15px; resize: none; height: 60px; max-height: 140px;
      outline: none; font-family: inherit; transition: all 0.3s ease; color: var(--hc-text-main);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
    }
    .hc-textarea:focus {
      background: #fff; border-color: var(--hc-primary);
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
   
    .hc-send-btn {
      width: 60px; height: 60px; border-radius: 16px;
      border: none; background: var(--hc-primary); color: var(--hc-accent);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); flex-shrink: 0;
      box-shadow: 0 8px 20px rgba(17, 24, 39, 0.25);
    }
    .hc-send-btn:hover { transform: scale(1.05) rotate(-10deg); background: #000; }
    .hc-send-btn:active { transform: scale(0.95); }
    .hc-send-btn svg { width: 26px; height: 26px; fill: currentColor; }
    .hc-send-btn:disabled { background: #d1d5db; color: #fff; transform: none; box-shadow: none; cursor: not-allowed; }

    /* Typing Animation */
    .hc-typing { display: inline-flex; gap: 5px; padding: 6px 0; }
    .hc-dot { width: 8px; height: 8px; background: #9ca3af; border-radius: 50%; animation: hcBlink 1.4s infinite; }
    .hc-dot:nth-child(2) { animation-delay: 0.2s; }
    .hc-dot:nth-child(3) { animation-delay: 0.4s; }

    /* === MEMNUNİYET ANKETİ (Overlay) === */
    .hc-survey-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(12px); /* Blur Effect */
      -webkit-backdrop-filter: blur(12px);
      display: flex; align-items: center; justify-content: center;
      z-index: 50; opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .hc-survey-overlay.active { opacity: 1; pointer-events: auto; }
   
    .hc-survey-card {
      background: #fff; padding: 40px; border-radius: 24px;
      text-align: center; max-width: 340px; width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15); border: 1px solid #fff;
      transform: translateY(20px); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .hc-survey-overlay.active .hc-survey-card { transform: translateY(0); }
   
    .hc-survey-title { font-size: 20px; font-weight: 800; margin-bottom: 8px; color: var(--hc-primary); }
    .hc-survey-desc { font-size: 14px; color: var(--hc-text-sub); margin-bottom: 24px; }
    .hc-stars { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
    .hc-star-btn { font-size: 28px; background: none; border: none; cursor: pointer; color: #e5e7eb; transition: 0.2s; }
    .hc-star-btn:hover, .hc-star-btn.active { color: #fbbf24; transform: scale(1.2); }
   
    .hc-survey-close {
      font-size: 13px; font-weight: 600; color: var(--hc-text-sub);
      background: #f3f4f6; padding: 10px 24px; border-radius: 99px; text-decoration: none;
      display: inline-block; cursor: pointer; transition: 0.2s;
    }
    .hc-survey-close:hover { background: var(--hc-primary); color: #fff; }

    /* Animasyonlar */
    @keyframes hcSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes hcFadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes hcBlink { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }

    /* === RESPONSIVE === */
    @media (max-width: 850px) {
      .hc-wrapper { width: 100%; height: 100%; border: none; border-radius: 0; grid-template-columns: 1fr; }
      .hc-brand-side { display: none; }
      .hc-chat-head { padding: 16px 20px; }
      .hc-msgs-area { padding: 20px; }
      .hc-input-area { padding: 16px 20px; }
      .hc-bubble { max-width: 85%; }
    }
  </style>
</head>
<body>

  <div class="hc-wrapper">
    <div class="hc-brand-side">
      <div class="hc-brand-header">
        <div class="hc-logo-icon">
          <svg viewBox="0 0 24 24"><path d="M3 21h18v-8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v8z"></path><path d="M5 11V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v4"></path><path d="M9 7V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3"></path></svg>
        </div>
        <div class="hc-brand-texts">
          <h1>STEIN<br>AUF STEIN</h1>
          <p>REAL ESTATE</p>
        </div>
      </div>
     
      <div class="hc-feature-list">
        <div class="hc-feature-item">
          <div class="hc-feature-icon">
             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
          </div>
          <div class="hc-feature-text">
            <h4>Güvenli Portföy</h4>
            <p>Hukuki denetimden geçmiş, risksiz gayrimenkul seçenekleri.</p>
          </div>
        </div>
        <div class="hc-feature-item">
          <div class="hc-feature-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
          </div>
          <div class="hc-feature-text">
            <h4>Yüksek Getiri</h4>
            <p>İstanbul'un en hızlı değerlenen bölgelerinde yatırım fırsatları.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="hc-chat-panel">
      <div class="hc-chat-head">
        <div class="hc-agent-info">
          <img src="https://images.unsplash.com/photo-1560250097-0b93528c311a?auto=format&fit=crop&w=100&q=80" class="hc-agent-avatar-head" alt="Danışman">
          <div class="hc-agent-text">
            <h3>Emre Yılmaz</h3>
            <span>Çevrimiçi</span>
          </div>
        </div>
        <button class="hc-end-chat-btn" id="hcEndBtn">Sohbeti Bitir</button>
      </div>

      <div class="hc-msgs-area" id="hcMsgs">
        <div class="hc-row hc-bot">
          <img src="https://images.unsplash.com/photo-1560250097-0b93528c311a?auto=format&fit=crop&w=100&q=80" class="hc-msg-avatar" alt="Bot">
          <div class="hc-bubble-group">
            <div class="hc-bubble">Merhaba, ben Emre. STEIN AUF STEIN ayrıcalığıyla size nasıl yardımcı olabilirim?</div>
          </div>
        </div>

        <div class="hc-suggestions" id="hcSuggestions">
          <div class="hc-chip" onclick="clickSuggestion('Evimin değerini öğrenmek istiyorum')">
            Evimin değerini öğrenmek istiyorum
          </div>
          <div class="hc-chip" onclick="clickSuggestion('İstanbul bölgesinde özel bir daire arıyorum.')">
            İstanbul bölgesinde özel bir daire arıyorum.
          </div>
          <div class="hc-chip" onclick="clickSuggestion('Evimi en hızlı yoldan satmak istiyorum')">
            Evimi en hızlı yoldan satmak istiyorum
          </div>
        </div>
      </div>

      <div class="hc-input-area">
        <div class="hc-textarea-wrap">
          <textarea id="hcText" class="hc-textarea" placeholder="Mesajınızı yazın..."></textarea>
        </div>
        <button id="hcSend" class="hc-send-btn">
          <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
      </div>
     
      <div class="hc-survey-overlay" id="hcSurvey">
        <div class="hc-survey-card">
          <div class="hc-survey-title">Memnun Kaldınız mı?</div>
          <div class="hc-survey-desc">Deneyiminizi değerlendirmeniz bizim için çok değerli.</div>
          <div class="hc-stars">
            <button class="hc-star-btn" onclick="rate(1)">★</button>
            <button class="hc-star-btn" onclick="rate(2)">★</button>
            <button class="hc-star-btn" onclick="rate(3)">★</button>
            <button class="hc-star-btn" onclick="rate(4)">★</button>
            <button class="hc-star-btn" onclick="rate(5)">★</button>
          </div>
          <div class="hc-survey-close" onclick="closeSurvey()">Kapat</div>
        </div>
      </div>

    </div>
  </div>

  <script>
    /* === API CONFIG === */
    const RAW_API_BASE = "https://hukuk-test.onrender.com";
    const API_BASE = RAW_API_BASE.replace(/\/+$/, '');
    const params = new URLSearchParams(location.search);
    const BRAND_KEY = params.get("brand") || "hukuk-test"; // Backend'in tanıdığı key

    if (params.get("embed") === "1") document.body.classList.add("hc-embed-mode");

    /* === UTILS === */
    function getOrCreateLS(key, genFn) {
      try { return localStorage.getItem(key) || (localStorage.setItem(key, genFn()), genFn()); } catch(_){ return genFn(); }
    }
    function uuidLike() { return "u_" + Math.random().toString(36).slice(2) + Date.now().toString(36); }
   
    // State
    let threadId = null;
    let sending = false;
    const VISITOR_ID = getOrCreateLS("sas_visitor_id", uuidLike);
    const SESSION_ID = "s_" + Math.random().toString(36).slice(2);
    const AGENT_IMG = "https://images.unsplash.com/photo-1560250097-0b93528c311a?auto=format&fit=crop&w=100&q=80";

    /* === DOM ELEMENTS === */
    const $msgs  = document.getElementById("hcMsgs");
    const $txt   = document.getElementById("hcText");
    const $send  = document.getElementById("hcSend");
    const $suggs = document.getElementById("hcSuggestions");
    const $survey = document.getElementById("hcSurvey");
    const $endBtn = document.getElementById("hcEndBtn");

    /* === SCROLL & UI LOGIC === */
    function scrollEnd(){
      // Smooth scroll en alta
      setTimeout(() => {
        $msgs.scrollTo({ top: $msgs.scrollHeight, behavior: 'smooth' });
      }, 50);
    }
   
    // Input Auto Resize
    $txt.addEventListener("input", function(){
      this.style.height = 'auto';
      let newHeight = Math.min(this.scrollHeight, 140);
      if(newHeight < 60) newHeight = 60;
      this.style.height = newHeight + 'px';
    });

    // Chip Click
    window.clickSuggestion = function(msg){
      $txt.value = msg;
      handleSend();
    };

    // Suggestions Hide
    function hideSuggestions(){
      if($suggs) {
        $suggs.style.opacity = '0';
        $suggs.style.transform = 'translateY(10px)';
        setTimeout(() => $suggs.style.display = 'none', 300);
      }
    }

    /* === SURVEY LOGIC === */
    $endBtn.addEventListener("click", () => {
      $survey.classList.add("active");
    });
    window.closeSurvey = function(){
      $survey.classList.remove("active");
    };
    window.rate = function(star){
      const stars = document.querySelectorAll(".hc-star-btn");
      stars.forEach((s, i) => {
        if(i < star) s.classList.add("active");
        else s.classList.remove("active");
      });
      // Burada backend'e puanı gönderebilirsiniz.
      setTimeout(() => {
        closeSurvey();
        // Belki teşekkür mesajı?
      }, 800);
    };

    /* === LIKE SYSTEM === */
    window.toggleLike = function(btn){
      btn.classList.toggle("liked");
      // Animasyon için scale efekti CSS'te var
    };

    /* === MESSAGE RENDERING === */
    function escapeHtml(s){ return (s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function addUser(text){
      hideSuggestions();
      const row = document.createElement("div");
      row.className = "hc-row hc-user";
      row.innerHTML = `<div class="hc-bubble">${escapeHtml(text)}</div>`;
      $msgs.appendChild(row);
      scrollEnd();
    }

    function addBotSkeleton(){
      const row = document.createElement("div");
      row.className = "hc-row hc-bot";
      row.innerHTML = `
        <img src="${AGENT_IMG}" class="hc-msg-avatar">
        <div class="hc-bubble-group">
          <div class="hc-bubble" id="hc-bot-bubble"></div>
          <div class="hc-typing" id="hc-bot-typing"><span class="hc-dot"></span><span class="hc-dot"></span><span class="hc-dot"></span></div>
         
          <div class="hc-bot-actions" id="hc-bot-actions">
            <button class="hc-like-btn" onclick="toggleLike(this)" title="Faydalı buldum">
              <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
              Faydalı
            </button>
          </div>
        </div>
      `;
      $msgs.appendChild(row);
      scrollEnd();
      return {
        bubble: row.querySelector("#hc-bot-bubble"),
        typing: row.querySelector("#hc-bot-typing"),
        actions: row.querySelector("#hc-bot-actions")
      };
    }

    function finishBot(node){
      if(node.typing) node.typing.remove();
      // Mesaj bitince Like butonu görünsün
      if(node.actions) node.actions.style.opacity = '1';
      scrollEnd();
    }

    /* === API HANDLING === */
    async function ensureThread(){
      if(threadId) return threadId;
      try {
        const r = await fetch(API_BASE + "/api/chat/init", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ brandKey: BRAND_KEY, visitorId: VISITOR_ID, sessionId: SESSION_ID })
        });
        if(!r.ok) throw new Error("Init");
        const j = await r.json();
        threadId = j.threadId;
        return threadId;
      } catch(e) { throw e; }
    }

    async function handleSend(){
      if(sending) return;
      const msg = ($txt.value || "").trim();
      if(!msg) return;

      sending = true; $send.disabled = true; $txt.disabled = true;
      addUser(msg);
      $txt.value = "";
      $txt.style.height = "60px"; // Reset height

      try {
        await ensureThread();
        const node = addBotSkeleton();
        let acc = "";

        const resp = await fetch(API_BASE + "/api/chat/stream", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ threadId, message: msg, brandKey: BRAND_KEY, visitorId: VISITOR_ID, sessionId: SESSION_ID })
        });

        if(resp.ok && resp.body){
          const reader = resp.body.getReader();
          const decoder = new TextDecoder();
          while(true){
            const { done, value } = await reader.read();
            if(done) break;
            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split("\n");
            for(const line of lines){
              if(line.startsWith("data:") && line !== "data: [DONE]"){
                try{
                  const evt = JSON.parse(line.slice(5));
                  const content = evt?.delta?.content || evt?.message?.content;
                  if(Array.isArray(content)){
                    const txt = content.find(c => c.type === 'text')?.text?.value;
                    if(txt) { acc += txt; node.bubble.textContent = acc; scrollEnd(); }
                  }
                }catch(_){}
              }
            }
          }
        } else {
          node.bubble.textContent = "Bağlantı sorunu, lütfen tekrar deneyin.";
        }
        finishBot(node);
      } catch(err) {
        console.error(err);
      } finally {
        sending = false; $send.disabled = false; $txt.disabled = false; $txt.focus(); scrollEnd();
      }
    }

    $send.addEventListener("click", handleSend);
    $txt.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleSend(); }
    });
   
    // Init check
    ensureThread().catch(()=>{});

  </script>
</body>
</html>